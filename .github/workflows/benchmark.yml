name: CI

on:
  push:
    branches:
      - main
    paths:
      - 'packages/dtsx/src/**'
      - 'packages/dtsx/benchmark.ts'
      - 'benchmark/**'

  pull_request:
    branches:
      - main
    paths:
      - 'packages/dtsx/src/**'
      - 'packages/dtsx/benchmark.ts'
      - 'benchmark/**'

  workflow_dispatch:
    inputs:
      full_benchmark:
        description: 'Run full benchmark (more iterations)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: benchmark-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Install Bun
        uses: oven-sh/setup-bun@v2.1.2

      - name: Install Zig
        uses: mlugg/setup-zig@v2

      - name: Use cached node_modules
        uses: actions/cache@v4.3.0
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            node-modules-

      - name: Install Dependencies
        run: bun install

      - name: Build dtsx
        run: bun run build
        working-directory: packages/dtsx

      - name: Build zig-dtsx
        run: zig build -Doptimize=ReleaseFast
        working-directory: packages/zig-dtsx

      - name: Run Internal Benchmarks
        run: |
          if [ "${{ github.event.inputs.full_benchmark }}" == "true" ]; then
            bun run benchmark.ts --json --output=benchmark-results.json
          else
            bun run benchmark.ts --ci --json --output=benchmark-results.json
          fi
        working-directory: packages/dtsx

      - name: Download Previous Benchmark
        uses: dawidd6/action-download-artifact@v14
        with:
          workflow: benchmark.yml
          branch: main
          name: benchmark-results-*
          path: base-benchmark
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Generate Summary (cross-tool comparison + regression detection)
        run: bun benchmark/ci-summary.ts --results packages/dtsx/benchmark-results.json --base base-benchmark/benchmark-results.json

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v6.0.0
        with:
          name: benchmark-results-${{ github.sha }}
          path: packages/dtsx/benchmark-results.json
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('benchmark-summary.md')) return;
            const comment = fs.readFileSync('benchmark-summary.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }
        continue-on-error: true
